name: Error Handler

on:
  workflow_run:
    workflows: ["Deploy to GitHub Pages", "Update Datasets from Brevo API", "Monitor Deployments"]
    types: [completed]
  issues:
    types: [opened]

jobs:
  handle-errors:
    runs-on: ubuntu-latest
    if: failure()
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Analyze error
      run: |
        echo "🔍 Analyzing deployment error..."
        
        # Get the failed workflow
        WORKFLOW_NAME="${{ github.event.workflow_run.name }}"
        WORKFLOW_CONCLUSION="${{ github.event.workflow_run.conclusion }}"
        
        echo "Failed workflow: $WORKFLOW_NAME"
        echo "Conclusion: $WORKFLOW_CONCLUSION"
        
        # Create error analysis
        cat > error-analysis.md << EOF
        # Error Analysis
        Generated: $(date)
        
        ## Failed Workflow
        - Name: $WORKFLOW_NAME
        - Conclusion: $WORKFLOW_CONCLUSION
        - URL: ${{ github.event.workflow_run.html_url }}
        
        ## Common Fixes
        
        ### If GitHub Pages failed:
        1. Check if package-lock.json exists
        2. Verify Node.js version compatibility
        3. Check build script in package.json
        
        ### If Vercel failed:
        1. Check Vercel project settings
        2. Verify build command
        3. Check environment variables
        
        ### If Brevo API failed:
        1. Check BREVO_API_KEY secret
        2. Verify API endpoint
        3. Check network connectivity
        
        ## Next Steps
        1. Review the failed workflow logs
        2. Apply the appropriate fix
        3. Re-run the workflow
        EOF
        
        cat error-analysis.md
        
    - name: Create detailed issue
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const analysis = fs.readFileSync('error-analysis.md', 'utf8');
          
          github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: `🔧 Auto-Fix Suggestion - ${{ github.event.workflow_run.name }}`,
            body: analysis,
            labels: ['auto-fix', 'deployment-error']
          });
